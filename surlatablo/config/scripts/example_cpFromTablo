#!/bin/sh

TODAY=`date +"%Y-%m-%d"`
YESTERDAY=`date --date='yesterday' +"%Y-%m-%d"`
PARITYCHECKINPROGRESS=`cat /proc/mdcmd | grep "mdResync=1"`

# reference surlatablo call that might come in handy commented out here.
# /config/scripts/surlatablo.py --convert --ccaption --query lair_date~="$TODAY|$YESTERDAY" 

# copy surlatablo configuration to the location the python script expects
cp -u /config/conf/surlatablo.conf /root/surlatablo.conf

if [ ! $PARITYCHECKINPROGRESS ]; then

    # always convert shows if they match last air date of "today", or "yesterday".

    # first process tv series recordings, leaving commercials and extracting subtitles as SRT
    /config/scripts/surlatablo.py -n -q lair_date~="($TODAY|$YESTERDAY)" | awk '{if ($2 =="TV") system ("/config/scripts/surlatablo.py --convert --ccaption --keepdir s --query rec_id~=" $1); }'

    # second process movies, and zap the commercials with the second Mp4z re-encode to sync up audio and video
    /config/scripts/surlatablo.py -n -q lair_date~="($TODAY|$YESTERDAY)" | awk '{if ($2 =="Movie") system ("/config/scripts/surlatablo.py --convert -z --query rec_id~=" $1 " Mp4z"); }'

fi
exit 0
